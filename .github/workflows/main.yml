name: LLM Jupyter CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:24.0.1-dind
        options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Install Ansible
        run: |
          sudo apt update
          sudo apt install -y ansible

      - name: Build Docker container
        run: |
          docker build -t llm-jupyter .

      - name: Run Docker container
        run: |
          docker run -d --name llm-jupyter -p 8888:8888 llm-jupyter \
            jupyter notebook --ip=0.0.0.0 --port=8888 --allow-root

      - name: Wait for Jupyter to be ready
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8888/ >/dev/null; then
              echo "Server is up!"
              break
            fi
            echo "Waiting for server..."
            sleep 2
          done
          if ! curl -s http://localhost:8888/ >/dev/null; then
            echo "ERROR: LLM server did not start!"
            exit 1
          fi
